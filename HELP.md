## ğŸš€ åˆ†ä½ˆå¼å»¶é²ä»»å‹™èª¿åº¦ç³»çµ±æ¶æ§‹è¨­è¨ˆ

### ğŸ¯ å°ˆæ¡ˆæ¦‚è¿° (Project Overview)
    æœ¬é …ç›®æ—¨åœ¨å»ºç«‹ä¸€å€‹é«˜å¯é ã€é«˜æ€§èƒ½çš„åˆ†ä½ˆå¼å»¶é²ä»»å‹™èª¿åº¦å¹³å°ã€‚ç³»çµ±åˆ©ç”¨ Redis Sorted Set ä½œç‚ºæ ¸å¿ƒèª¿åº¦ç·©è¡å€ï¼Œçµåˆ MySQL é€²è¡ŒæŒä¹…åŒ–ï¼Œä¸¦é€šé RocketMQ å¯¦ç¾ä»»å‹™çš„æœ€çµ‚ç•°æ­¥åŸ·è¡Œï¼Œè§£æ±ºäº†å‚³çµ±å–®é«”æ‡‰ç”¨ä¸­å®šæ™‚ä»»å‹™çš„å–®é»æ•…éšœå’Œæ™‚é–“ç²¾åº¦å•é¡Œã€‚

##### æ ¸å¿ƒæŠ€è¡“æ£§ (Technology Stack)
    redis -> ä»»å‹™èª¿åº¦çš„æ ¸å¿ƒéšŠåˆ—ï¼Œåˆ©ç”¨ Score (æ™‚é–“æˆ³) å¯¦ç¾é«˜æ•ˆæ’åºå’Œç¯„åœæŸ¥è©¢ã€‚
    mysql -> ä»»å‹™è³‡æ–™çš„æœ€çµ‚ä¾†æº
    rocketMq -> è² è²¬å°‡å·²åˆ°æœŸä»»å‹™ç•°æ­¥ç™¼é€çµ¦æ¶ˆè²»ç«¯åŸ·è¡Œï¼Œè§£è€¦èª¿åº¦èˆ‡åŸ·è¡Œã€‚


### ğŸ—ï¸ ç³»çµ±æ¶æ§‹èˆ‡æµç¨‹ (Architecture & Data Flow)

    1. ä»»å‹™å‰µå»º (Task Creation)
        * API æ¥æ”¶ï¼š æ¥æ”¶ TaskRequestï¼ŒåŒ…å« executeAt (åŸ·è¡Œæ™‚é–“) å’Œ payload (ä»»å‹™å…§å®¹)ã€‚
        * æŒä¹…åŒ–ï¼š å°‡ä»»å‹™å¯¦é«” (TaskEntity) å„²å­˜åˆ° MySQL (scheduled_tasks è¡¨)ï¼Œç‹€æ…‹è¨­ç‚º PENDINGã€‚
        * èª¿åº¦å¯«å…¥ (Atomic Write)ï¼š å°‡ä»»å‹™ ID ä½œç‚º Memberï¼ŒexecuteAt çš„æ¯«ç§’æ™‚é–“æˆ³ä½œç‚º Scoreï¼ŒZADD åˆ° Redis ZSet ä¸­ã€‚
        * ç·©å­˜æ›´æ–°ï¼š ä½¿ç”¨ Spring Cache (@CachePut) å°‡ä»»å‹™å¯¦é«”ç·©å­˜åˆ° Redisã€‚

    2. ä»»å‹™èª¿åº¦ (Task Polling)
    * Poller æ©Ÿåˆ¶ï¼š ç³»çµ±å…§éƒ¨å•Ÿå‹•ä¸€å€‹ç¨ç«‹ã€å¤šç·šç¨‹çš„ TaskPoller (@Scheduled è¨»è§£)ï¼Œå®šæ™‚åŸ·è¡Œã€‚
    * åŸå­æ€§ç²å–ï¼š Poller ä½¿ç”¨ä¸€å€‹ Redis Lua è…³æœ¬ï¼ŒåŸå­æ€§åœ°åŸ·è¡Œä»¥ä¸‹æ“ä½œï¼šZRANGEBYSCORE key 0 NOW()ï¼šç²å–æ‰€æœ‰ Score $\le$ ç•¶å‰æ™‚é–“ (NOW()) çš„ä»»å‹™ IDã€‚ZREM key taskIds...ï¼šç«‹å³å¾ ZSet ä¸­åˆªé™¤é€™äº› IDã€‚
    * è¨Šæ¯ç™¼é€ï¼š ç²å–çš„ä»»å‹™ ID è¢«å‚³éçµ¦ TaskServiceï¼Œæœå‹™ä½¿ç”¨ RocketMQTemplate å°‡ä»»å‹™ payload ç™¼é€åˆ°æŒ‡å®šçš„ Topic/Tagã€‚
    * ç‹€æ…‹æ›´æ–°ï¼š ä»»å‹™åœ¨ MySQL ä¸­çš„ç‹€æ…‹è¢«æ›´æ–°ç‚º TRIGGEREDã€‚

### å»¶ä¼¸å¯¦ä½œ&è¨è«–

* é€±æœŸæ€§æƒæï¼š è¨­ç½®ä¸€å€‹ @Scheduled å®šæ™‚ä»»å‹™ï¼ˆä¾‹å¦‚æ¯ 5 åˆ†é˜ï¼‰ï¼ŒæŒçºŒæƒæ MySQL ä¸­ç‹€æ…‹ç‚º PENDING ä½†åœ¨ Redis ZSet ä¸­ç¼ºå¤±çš„ä»»å‹™ï¼Œå°‡å…¶è£œéŒ„ï¼Œä¸¦æ¸…é™¤ Redis ä¸­å·²åœ¨ MySQL ä¸­è¢«æ¨™è¨˜ç‚º TRIGGERED/CANCELLED çš„é«’æ•¸æ“šã€‚
* mqé‡é€è£œå„Ÿæ©Ÿåˆ¶ï¼š ç•¶mqé­é‡é€£ç·šç•°å¸¸ç­‰ä¾‹å¤–æ™‚ï¼Œå­˜è¡¨å¦è¡Œç™¼é€ï¼Œä¸”å‘ŠçŸ¥ä¸‹æ¸¸æ–¹å”¯ä¸€å€¼ï¼Œä¿è­‰ä¸é‡è¤‡æ¶ˆè²»ã€‚
* dbå¯¦ä½œï¼š å°‡ç¯€é»ç‹€æ…‹åŒ–ï¼Œä½¿å¾—è©²ç¯€é»ä¿è­‰åªæœƒè™•ç†å±¬æ–¼è‡ªå·±çš„ä»»å‹™ã€‚
* zseté‡éå¤§ï¼šç•¶zsetçš„keyå¤§æ–¼10è¬æ™‚ï¼Œæœƒå½±éŸ¿è©²æ•ˆèƒ½ï¼Œå¯è€ƒæ…®å°‡keyé€²è¡Œåˆ†ç‰‡ã€‚


### æ¸¬è©¦
har æª”æ¡ˆå¯åŒ¯å…¥æ¸¬è©¦ï¼Œæˆ–æ˜¯é€éä¸‹æ–¹curlæ¸¬è©¦
homework-backend_2025-12-01.har

ä»¥ä¸‹ç‚ºcurl

---

##### å‰µå»ºä»»å‹™
````
curl --request POST \
--url http://localhost:9090/tasks \
--header 'Content-Type: application/json' \
--header 'User-Agent: insomnia/12.1.0' \
--data '{
"taskId": "abc-123",
"executeAt": "2025-12-01T13:43:59Z",
"payload": {
"type": "email",
"target": "hello@example.com",
"message": "This is a scheduled task!"
}
}'
````
##### ç²å–å–®ç­†ä»»å‹™
````
curl --request GET \
  --url http://localhost:9090/tasks/abc-140 \
  --header 'User-Agent: insomnia/12.1.0'
````
##### å–æ¶ˆä»»å‹™
````
curl --request DELETE \
  --url http://localhost:9090/tasks/abc-138 \
  --header 'User-Agent: insomnia/12.1.0'
````
##### ç²å–åˆ—è¡¨ä»»å‹™
````
curl --request GET \
  --url 'http://localhost:9090/tasks?page=1&size=2' \
  --header 'User-Agent: insomnia/12.1.0'
````